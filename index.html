<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IBASE 26th Anniversary</title>

  <style>
    :root{
      --border:#cfcfcf;
      --text:#222;
      --muted:#666;
      --accent:#2563eb;
      --seatFill:#ffffff;
      --seatStroke:#444;
      --aisle:#efefef;
      --stage:#f6c200;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif;
      color:var(--text);
      background:#fafafa;
    }

    header{
      max-width:1200px;
      margin:0 auto;
      padding:16px 16px 8px;
    }

    h1{
      margin:0 0 10px;
      font-size:18px;
    }

    .toolbar{
      display:grid;
      grid-template-columns:1fr auto auto;
      gap:10px;
      align-items:center;
    }

    input{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:14px;
      outline:none;
      background:#fff;
    }

    input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(37,99,235,.15);
    }

    button{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-size:14px;
    }

    button:hover{
      background:#f5f5f5;
    }

    .hint{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding:8px 16px 24px;
    }

    .frame{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      overflow:auto;
    }

    svg{
      width:100%;
      height:auto;
      min-width:980px;
    }

    @media (max-width: 768px) {
      svg{
        min-width:0;
      }
    }

    .seat circle{
      fill:var(--seatFill);
      stroke:var(--seatStroke);
      stroke-width:2;
    }

    .seat text{
      font-size:14px;
      font-weight:700;
      text-anchor:middle;
      dominant-baseline:middle;
      fill:#111;
      pointer-events:none;
    }

    .seat.big text{
      font-size:15px;
    }

    .seat.hit circle{
      stroke:#e11d48;
      stroke-width:4;
      filter:drop-shadow(0 0 6px rgba(225,29,72,.45));
    }

    .label{
      font-size:14px;
      fill:#333;
      font-weight:700;
    }

    .label.muted{
      fill:#666;
      font-weight:600;
      font-size:13px;
    }

    .aisle{
      fill:var(--aisle);
      stroke:#d0d0d0;
      stroke-width:1.5;
      rx:8;
    }

    .stage{
      fill:var(--stage);
      stroke:#caa000;
      stroke-width:2;
      rx:10;
    }

    .outer{
      fill:none;
      stroke:#777;
      stroke-width:2;
      rx:14;
    }
  </style>
</head>

<body>
  <header>
    <h1>座位圖</h1>

    <div class="toolbar">
      <input id="q" type="text" placeholder="搜尋桌號或姓名：127、林佳穎" />
      <button id="btnSearch" type="button">搜尋</button>
      <button id="btnReset" type="button">重設</button>
    </div>
  </header>

  <main>
    <div class="frame">
      <svg id="map" viewBox="0 0 1000 560" role="img" aria-label="127桌座位圖">

        <rect class="outer" x="20" y="20" width="960" height="520"></rect>

        <rect class="stage" x="400" y="80" width="220" height="80"></rect>
        <text class="label" x="500" y="125">舞台</text>

        <rect class="aisle" x="280" y="80" width="45" height="405"></rect>
        <text class="label muted" x="347.5" y="270" transform="rotate(-90 347.5 310)">升降星光大道</text>

        <rect class="aisle" x="690" y="130" width="45" height="355"></rect>
        <text class="label muted" x="702.5" y="325" transform="rotate(-90 702.5 310)">升降星光大道</text>

        <rect class="aisle" x="210" y="21" width="180" height="50"></rect>
        <text class="label" x="280" y="40">L E D</text>

        <rect class="aisle" x="625" y="21" width="180" height="50"></rect>
        <text class="label" x="695" y="40">L E D</text>

        <rect class="aisle" x="470" y="252" width="70" height="35"></rect>
        <text class="label" x="485" y="275">攝影台</text>

        <g id="seats"></g>
      </svg>
    </div>

    <div id="infoBox" style="
      background:#fff;
      border:1px solid #cfcfcf;
      border-radius:14px;
      padding:12px 14px;
      margin-bottom:10px;
      font-size:14px;
    ">
      <div style="font-weight:800; margin-bottom:6px;">尚未選擇桌位</div>
      <div style="color:#666; font-size:13px;">請點選桌位顯示桌號與人名。</div>
    </div>
  </main>

  <script>
    // 每桌的人名清單
	const seatNames = {
		"1": [
			"Alex",
			"Andy",
			"Alen",
			"Allen"
		],
		"2": [
			"aaa",
			"bbb",
			"ccc",
			"ddd",
			"eee",
			"fff",
			"ggg",
			"hhh",
			"iii",
			"jjj",
			"kkk",
			"kkkZZ"
		]
	};
//    const seatNames = {
//      "1": [
//        "林秋旭",
//        "林佳穎"
//      ],
//      "20": [
//        "Charlie",
//        "陳美麗",
//        "林志豪",
//        "黃怡君",
//        "張家豪",
//        "貴賓",
//        "貴賓",
//        "貴賓",
//        "貴賓",
//        "貴賓",
//        "貴賓",
//        "貴賓"
//      ],
//      "21": [
//        "Alice",
//        "Bob",
//        "陳美麗",
//        "David",
//        "Eve",
//        "Frank",
//        "Grace",
//        "Heidi",
//        "Ivan",
//        "Judy"
//      ],
//      "127": [
//        "董事長",
//        "總經理",
//        "副總A",
//        "副總B",
//        "貴賓一",
//        "貴賓二",
//        "貴賓三",
//        "貴賓四",
//        "貴賓五",
//        "貴賓六"
//      ]
//    };

    // 取得桌號對應的人名，若沒有設定則回傳空陣列
    function getNames(no){
      return seatNames[String(no)] || [];
    }

    // 座位資料
    // no 是桌號
    // x y 是 SVG 座標位置
    // r 是桌位圓形半徑
    const seats = [];

    // 建立一筆座位資料並加入 seats
    function add(no, x, y, r=18){
      seats.push({
        no: String(no),
        x,
        y,
        r,
        names: getNames(no)
      });
    }

    // 左上角兩桌
    add(52, 150, 105, 18);
    add(53, 250, 105, 18);

    // 左區 54 到 89
    const lx = [100,150,200,250];
    const leftRows = [
      [54,55,56,57],
      [58,59,60,61],
      [62,63,64,65],
      [66,67,68,69],
      [70,71,72,73],
      [74,75,76,77],
      [78,79,80,81],
      [82,83,84,85],
      [86,87,88,89]
    ];
    const leftY = [150,190,230,270,310,350,390,430,470];

    for (let i=0; i<leftRows.length; i++){
      for (let j=0; j<4; j++){
        add(leftRows[i][j], lx[j], leftY[i], 18);
      }
    }

    // 左中直列 42 到 51
    add(42, 355, 105, 18);
    const col42to51 = [43,44,45,46,47,48,49,50,51];
    const colY = [150,190,230,270,310,350,390,430,470];

    for (let i=0; i<col42to51.length; i++){
      add(col42to51[i], 355, colY[i], 18);
    }

    // 主桌 1 到 5
    add(1, 401, 215, 20);
    add(2, 460, 215, 20);
    add(3, 515, 215, 20);
    add(4, 570, 215, 20);
    add(5, 620, 205, 20);

    // 右上方 127 與 6
    add(127, 710, 105, 18);
    add(6,   658, 170, 18);

    // 右側直列
    const rightCol = [
      {no:11, y:240},
      {no:18, y:287},
      {no:19, y:335},
      {no:26, y:380},
      {no:33, y:425},
      {no:40, y:470}
    ];
    rightCol.forEach(o => add(o.no, 658, Math.min(o.y, 470), 18));

    // 中間桌位
    add(7,  400, 270, 18);
    add(8,  442, 270, 18);
    add(9,  568, 270, 18);
    add(10, 610, 270, 18);

    // 12 到 17
    const row12 = [12,13,14,15,16,17];
    const x12 = [400,442,484,526,568,610];
    const y12 = 320;

    for (let i=0; i<row12.length; i++){
      add(row12[i], x12[i], y12, 18);
    }

    // 20 到 25
    const row20 = [20,21,22,24,25];
    const x20 = [400,442,484,568,610];
    const y20 = 370;

    for (let i=0; i<row20.length; i++){
      add(row20[i], x20[i], y20, 18);
    }

    // 23 30 37
    add(23, 526, 362, 18);
    add(30, 526, 408, 18);
    add(37, 526, 452, 18);

    // 27 到 32
    const row27 = [27,28,29,31,32];
    const x27 = [400,442,484,568,610];
    const y27 = 420;

    for (let i=0; i<row27.length; i++){
      add(row27[i], x27[i], y27, 18);
    }

    // 34 到 39
    const row34 = [34,35,36,38,39];
    const x34 = [400,442,484,568,610];
    const y34 = 470;

    for (let i=0; i<row34.length; i++){
      add(row34[i], x34[i], y34, 18);
    }

    // 41
    add(41, 526, 495, 18);

    // 右區 90 到 126
    add(90, 865, 105, 18);
    const rx = [765,815,865,915];
    const ry = [150,190,230,270,310,350,390,430,470];
    const rightRows = [
      [91,92,93,94],
      [95,96,97,98],
      [99,100,101,102],
      [103,104,105,106],
      [107,108,109,110],
      [111,112,113,114],
      [115,116,117,118],
      [119,120,121,122],
      [123,124,125,126]
    ];

    for (let i=0; i<rightRows.length; i++){
      for (let j=0; j<4; j++){
        add(rightRows[i][j], rx[j], ry[i], 18);
      }
    }

    // 依桌號取得 seats 內的桌位資料
    function findSeat(no){
      return seats.find(s => s.no === String(no));
    }

    // 顯示桌位資訊到 infoBox
    // no 為空則顯示預設畫面
    function showSeatInfo(no){
      const box = document.getElementById("infoBox");
      if (!box) return;

      if (!no){
        box.innerHTML = `
          <div style="font-weight:800; margin-bottom:6px;">尚未選擇桌位</div>
          <div style="color:#666; font-size:13px;">請點選桌位顯示桌號與人名。</div>
        `;
        return;
      }

      const seat = findSeat(no);
      if (!seat){
        box.innerHTML = `
          <div style="font-weight:800; margin-bottom:6px;">找不到桌位：${no}</div>
        `;
        return;
      }

      const names = seat.names && seat.names.length ? seat.names : ["此桌尚未設定人名"];
      const list = names.map(n => `<li style="margin:2px 0;">${n}</li>`).join("");

      box.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
          <div style="font-weight:900; font-size:16px;">桌號：${seat.no}</div>
          <div style="color:#666; font-size:13px;">共 ${seat.names.length} 人</div>
        </div>
        <ol style="margin:0; padding-left:18px;">
          ${list}
        </ol>
      `;
    }

    // 將文字轉成安全字串，避免插入 HTML
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c)=>({
        "&":"&amp;",
        "<":"&lt;",
        ">":"&gt;",
        '"':"&quot;",
        "'":"&#39;"
      }[c]));
    }

    // 在 infoBox 顯示錯誤訊息，使用紅色文字
    function showError(msg, detail=""){
      const box = document.getElementById("infoBox");
      if (!box) return;

      box.innerHTML = `
        <div style="font-weight:900; margin-bottom:6px; color:#e11d48;">${escapeHtml(msg)}</div>
        ${detail ? `<div style="color:#666; font-size:13px; white-space:pre-wrap;">${escapeHtml(detail)}</div>` : ""}
      `;
    }

    // 清除所有桌位的命中標記
    function clearMarks(){
      document.querySelectorAll(".seat").forEach(el => el.classList.remove("hit"));
    }

    // 渲染所有座位到 SVG
    const seatsG = document.getElementById("seats");

    function seatEl(s){
      const g = document.createElementNS("http://www.w3.org/2000/svg","g");
      g.setAttribute("class", "seat" + (s.r>=20 ? " big" : ""));
      g.dataset.no = s.no;

      // 把此桌所有名字存入 dataset，並轉小寫方便搜尋
      g.dataset.names = (s.names || []).join(" ").toLowerCase();

      const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx", s.x);
      c.setAttribute("cy", s.y);
      c.setAttribute("r", s.r);

      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x", s.x);
      t.setAttribute("y", s.y);
      t.textContent = s.no;

      g.appendChild(c);
      g.appendChild(t);

      // 點桌位就高亮並顯示該桌名單
      g.addEventListener("click", () => {
        clearMarks();
        g.classList.add("hit");
        showSeatInfo(s.no);
        g.scrollIntoView({behavior:"smooth", block:"center", inline:"center"});
      });

      return g;
    }

    seats.forEach(s => seatsG.appendChild(seatEl(s)));

    // 搜尋功能
    const q = document.getElementById("q");
    const btnSearch = document.getElementById("btnSearch");
    const btnReset = document.getElementById("btnReset");

    // 解析輸入文字是否為桌號形式
    // 支援 單一桌號 例如 127
    // 支援 多桌號 例如 12, 15, 18
    // 支援 區間 例如 10-20
    function parseQueryToNos(text){
      const t = text.trim();
      if (!t) return null;

      if (t.includes(",")){
        const nums = t
          .split(",")
          .map(x=>x.trim())
          .filter(Boolean)
          .map(x=>Number(x))
          .filter(n=>Number.isFinite(n))
          .map(n=>String(n));
        return nums.length ? Array.from(new Set(nums)) : null;
      }

      const m = t.match(/^(\d+)\s*-\s*(\d+)$/);
      if (m){
        const a = Number(m[1]);
        const b = Number(m[2]);
        const lo = Math.min(a,b);
        const hi = Math.max(a,b);
        const arr = [];
        for (let x=lo; x<=hi; x++){
          arr.push(String(x));
        }
        return arr;
      }

      if (/^\d+$/.test(t)){
        return [String(Number(t))];
      }

      return null;
    }

    // 套用搜尋
    // 若輸入是桌號就以桌號比對
    // 若輸入是姓名就以姓名完全相等比對
    // 若找不到就把錯誤顯示在 infoBox
    function applySearch(){
      const text = q.value.trim();
      clearMarks();
      if (!text) return;

      const nos = parseQueryToNos(text);
      const needle = text.toLowerCase();

      let first = null;

      document.querySelectorAll(".seat").forEach(el => {
        const no = el.dataset.no;
        const namesStr = el.dataset.names || "";
        const namesArr = namesStr.split(" ").filter(Boolean);

        let hit = false;

        if (nos && nos.includes(no)) hit = true;
        if (!hit && !nos && namesArr.some(n => n === needle)) hit = true;
        if (!hit && needle === "福" && no === "127") hit = true;

        if (hit){
          el.classList.add("hit");
          if (!first) first = el;
        }
      });

      if (first){
        first.scrollIntoView({behavior:"smooth", block:"center"});
        showSeatInfo(first.dataset.no);
      }else{
        showError("找不到符合的桌位或姓名", `你輸入的是：${text}`);
      }
    }

    // 綁定事件
    btnSearch.addEventListener("click", applySearch);
    q.addEventListener("keydown", (e)=>{ if(e.key==="Enter") applySearch(); });

    // 重設：清空搜尋字並回到預設顯示
    btnReset.addEventListener("click", ()=>{ 
      q.value = "";
      clearMarks();
      showSeatInfo();
    });
  </script>

  <script>
    if ('WebSocket' in window) {
      (function () {
        function refreshCSS() {
          var sheets = [].slice.call(document.getElementsByTagName("link"));
          var head = document.getElementsByTagName("head")[0];
          for (var i = 0; i < sheets.length; ++i) {
            var elem = sheets[i];
            var parent = elem.parentElement || head;
            parent.removeChild(elem);
            var rel = elem.rel;
            if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
              var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
              elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
            }
            parent.appendChild(elem);
          }
        }
        var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
        var address = protocol + window.location.host + window.location.pathname + '/ws';
        var socket = new WebSocket(address);
        socket.onmessage = function (msg) {
          if (msg.data == 'reload') window.location.reload();
          else if (msg.data == 'refreshcss') refreshCSS();
        };
        if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
          console.log('Live reload enabled.');
          sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
        }
      })();
    } else {
      console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
    }
  </script>
</body>
</html>